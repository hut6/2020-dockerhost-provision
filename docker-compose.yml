version: "3.7"

services:

    traefik:
        image: traefik:v2.2
        networks:
            - server_network
            - node_network
        deploy:
            mode: global
            placement:
                constraints:
                    - node.role == manager
            restart_policy:
                condition: any
            update_config:
                order: start-first
                parallelism: 1
            labels:
                - "traefik.enable=true"
                - "traefik.http.middlewares.redirector.redirectScheme.scheme=https"
                - "traefik.http.middlewares.redirector.redirectScheme.permanent=true"
                - "traefik.http.services.httpsredirect.loadbalancer.server.port=80"
                - "traefik.http.routers.httpsredirect.rule=HostRegexp(`{host:.+}`)"
                - "traefik.http.routers.httpsredirect.entryPoints=web"
                - "traefik.http.routers.httpsredirect.middlewares=redirector"
                - "traefik.http.routers.httpsredirect.priority=1000"
        command:
            - "--log.level=INFO"
            - "--api.insecure=false"
            - "--providers.docker=true"
            - "--providers.docker.exposedbydefault=false"
            - "--providers.docker.swarmMode=true"
            - "--providers.docker.network=server_network"
            - "--entrypoints.web.address=:80"
            - "--entrypoints.websecure.address=:443"
            - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
            - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
            - "--certificatesresolvers.myresolver.acme.email=team@hutsix.com.au"
            - "--certificatesresolvers.myresolver.acme.storage=/acme/acme.json"
            - "--metrics.prometheus=true"
            - "--metrics.prometheus.addServicesLabels=true"
            - "--metrics.prometheus.addEntryPointsLabels=true"
            - "--metrics.prometheus.entryPoint=metrics"
            - "--entryPoints.metrics.address=:8082"
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - /etc/localtime:/etc/localtime:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - traefik-data:/acme

    node_exporter:
        image: quay.io/prometheus/node-exporter:v1.0.1
        deploy:
            mode: global
            restart_policy:
                condition: any
        networks:
            - node_network
        volumes:
            - /:/host:ro,rslave
        command:
            - "--path.rootfs=/host"
            - "--no-collector.arp"
            - "--no-collector.bcache"
            - "--no-collector.bonding"
            - "--no-collector.conntrack"
            - "--no-collector.edac"
            - "--no-collector.entropy"
            - "--no-collector.filefd"
            - "--no-collector.infiniband"
            - "--no-collector.mdadm"
            - "--no-collector.nfs"
            - "--no-collector.nfsd"
            - "--no-collector.pressure"
            - "--no-collector.rapl"
            - "--no-collector.schedstat"
            - "--no-collector.sockstat"
            - "--no-collector.softnet"
            - "--no-collector.stat"
            - "--no-collector.thermal_zone"
            - "--no-collector.timex"
            - "--no-collector.vmstat"
            - "--no-collector.xfs"
            - "--no-collector.zfs"

    cadvisor:
        image: gcr.io/google-containers/cadvisor:v0.36.0
        deploy:
            mode: global
            restart_policy:
                condition: any
        command:
            - "--disable_metrics=tcp,udp,disk,advtcp,sched,process"
            - "--storage_duration=0m50s"
            - "--application_metrics_count_limit=100"
            - "--housekeeping_interval=20s"
            - "--store_container_labels=false"
            - "--docker_only"
        networks:
            - node_network
        volumes:
            - /:/rootfs:ro
            - /var/run:/var/run:ro
            - /sys:/sys:ro
            - /var/lib/docker/:/var/lib/docker:ro

    agent:
        image: grafana/agent:latest
        deploy:
            mode: global
            restart_policy:
                condition: any
        dns: 8.8.8.8
        volumes:
            - agent-data:/tmp/agent
            - /var/log:/var/log
            - /etc/docker/grafana-agent/:/etc/grafana-agent/
        entrypoint:
            - /bin/agent
            - -config.file=/etc/grafana-agent/grafana-agent.yml
            - -prometheus.wal-directory=/tmp/agent/wal
        networks:
            - node_network
        ports:
            - "12345:12345"

networks:
    server_network:
        name: server_network
        driver: overlay
    node_network:
        name: node_network
        driver: overlay

volumes:
    traefik-data:
    agent-data:
